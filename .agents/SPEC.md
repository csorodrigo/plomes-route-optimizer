# Canuto Framework — Specification v1.0

> Consolidated from detailed interview on 2025-02-25.
> Author: Rodrigo Canuto. Compiled by: Claude.

---

## 1. Vision

A personal multi-agent framework for AI-assisted development that:

- Bootstraps into any project with minimal setup.
- Keeps persistent context between sessions to save tokens and reduce rework.
- Orchestrates multiple personas with clear boundaries and handoffs.
- Adapts to existing projects ("foreign-schema") without forcing its own patterns.
- Is Claude-first but provider-agnostic enough to work with Codex, GLM, and others.

---

## 2. Architecture Decisions

### 2.1 Distribution

| Decision | Choice |
|----------|--------|
| Method | **GitHub template repo** |
| Sync with central | **Manual** (no subtree/submodule). Template is a snapshot; updates are applied manually. |
| Template scope | **Framework only** — just `.agents/` + `CLAUDE.md`. No boilerplate, no stack opinion. |

### 2.2 Location in Projects

| Decision | Choice |
|----------|--------|
| Framework folder | **`.agents/`** (hidden, like `.github/` or `.vscode/`) |
| Entrypoint file | **`CLAUDE.md`** at project root (generated by template, generic defaults) |

### 2.3 Provider Strategy

| Decision | Choice |
|----------|--------|
| Primary provider | **Claude** (Maestro is always Claude) |
| Secondary providers | **Codex, GLM** (Coder and other execution personas can be delegated) |
| Agnosticism level | **Claude-first, agnostic** — markdowns are generic enough for other tools |
| Multi-provider orchestration | **Maestro delegates via API** (future goal, not MVP) |
| Entrypoint compatibility | `CLAUDE.md` is the main file; other tools can read it as plain markdown |

### 2.4 Customization Model

| Decision | Choice |
|----------|--------|
| Per-project changes | **None** — framework is used as-is |
| Project-specific additions | Via context files (`.context.md`, `FEATURE-MAP.md`) that the framework generates |
| Plugin architecture | **Core + plugins** in a monorepo with opt-in |

### 2.5 Language

| Decision | Choice |
|----------|--------|
| Framework language | **English** (all personas, skills, docs) |

---

## 3. Personas

### 3.1 Roster

| Persona | Role | Provider | Tier | Status |
|---------|------|----------|------|--------|
| **Maestro** | Orchestrator. Coordinates all personas, manages session lifecycle, detects project style. | Claude (always) | tier-1 | Complete |
| **Architect** | Plans features and refactors. Produces step-by-step plans. | Claude | tier-1 | Complete |
| **Coder** | Implements code per the Architect's plan. Writes basic tests. | Mixed (Claude/Codex/GLM) | tier-2 | Complete |
| **Tester** | QA specialist. Focuses on edge cases, error scenarios, coverage gaps. Validates that Coder's tests are sufficient. | Mixed | tier-2 | Complete |
| **Debugger** | Investigates test failures. Diagnoses root cause and proposes fixes. | Mixed | tier-2 | Complete |
| **Reviewer** | Reviews code for correctness, style, plan alignment. Produces analysis + checklist. | Different-from-coder | tier-2 | Complete |
| **Contextualizer** | Scans codebase, generates and maintains `.context.md` and `FEATURE-MAP.md`. | Claude | tier-1 | Complete |

### 3.2 Standard Flow

```
Maestro → Architect → Coder → Tester → Reviewer
                                  ↓ (if tests fail)
                              Debugger → Coder (fix) → Tester (re-run)
```

- Maestro orchestrates the full flow.
- Contextualizer is called by Maestro at session start (bootstrap or stale check) and after significant changes.
- Debugger is triggered **only when tests fail**. Not part of the happy path.

### 3.3 Handoff Protocol

- Handoffs are **explicit and visible** to the user.
- The Claude announces each persona transition: "Now acting as Architect. Plan: ..."
- Only major transitions are announced (plan → code → test → review), not micro-steps.

### 3.4 Error Escalation

- When any persona encounters something unexpected (not in plan, missing dependency, conflict):
  - **Escalate to Maestro**.
  - Maestro decides: re-plan with Architect, resolve inline, or ask user.
  - No autonomous decisions on unexpected situations.

### 3.5 Compliance Improvements (Priority #1)

Current problems (all three apply):
1. Prompts are too long → LLM loses focus.
2. Instructions are too vague → LLM interprets freely.
3. LLM ignores boundaries → does everything at once instead of respecting persona divisions.

Improvements applied:
- Shorter, more focused persona definitions.
- Concrete examples in each playbook (input → expected output).
- Explicit "DO NOT" lists with specific anti-patterns.
- Structured output formats (not just prose instructions).
- Clear scope boundaries with checksums (e.g., "Your output MUST contain exactly: [plan, checklist]. Nothing else.").

---

## 4. Skills

### 4.1 Core Skills

| Skill | Purpose |
|-------|--------|
| `context-maintenance` | How to maintain `.context.md` and `FEATURE-MAP.md` |
| `api-design` | How to design and evolve HTTP/JSON APIs |
| `frontend-implementation` | How to implement frontend features |
| `cli-usage` | How to safely use CLI commands and scripts |
| `security-practices` | Rules for handling .env, API keys, secrets |
| `git-workflow` | Branching, conventional commits, PR templates (opt-in) |

### 4.2 Advanced Skills

| Skill | Purpose |
|-------|--------|
| `plugin-system` | How to create, install, and manage opt-in plugins |
| `multi-provider` | How Maestro delegates to Claude, Codex, GLM |
| `metrics` | Quality, velocity, and compliance tracking |
| `squads` | Parallel workstreams for larger projects |

### 4.3 Plugin Architecture

- Structure: **monorepo with opt-in**.
- Core skills live in `.agents/skills/`.
- Plugin skills live in `.agents/plugins/<name>/` (optional, per-project).
- Each plugin has a `plugin.md` manifest.
- Core always wins on name conflicts; plugins use namespaced names.
- Maestro discovers plugins on session start and announces them.

---

## 5. Memory & Session Persistence

### 5.1 Memory Structure

```
.agents/
  memory/
    last-session.md    — Summary of last session (overwritten each time)
    decisions.md       — Append-only log of architectural/business decisions
    pending.md         — Tasks pending from previous sessions
    metrics.md         — Append-only session metrics log
```

### 5.2 Session Start Briefing

When Maestro starts a new session:

1. Read `.agents/memory/last-session.md` → show **short summary** of what changed.
2. Check for **stale contexts** (git-based diff: compare `.context.md` timestamps vs file changes).
3. Scan `.agents/plugins/` for active plugins.
4. Report all to user before starting work.

Format:
```
Session Briefing:
- Last session (2025-02-24): Implemented user auth flow, added JWT middleware.
- Stale contexts: src/api/ (3 files changed since last .context.md update)
- Pending: Integration tests for auth flow.
- Active plugins: ci-pipeline, database-migrations.
```

### 5.3 Session End

Before closing, Maestro:

1. Writes `last-session.md` with: date, what was done, decisions made, what's pending.
2. Updates `pending.md` if there are unfinished tasks.
3. Appends to `decisions.md` if any architectural decisions were made.
4. Appends session metrics to `metrics.md`.

### 5.4 Token Economy Strategy

- **Invest in bootstrap**: first session scans thoroughly and generates rich context files.
- Subsequent sessions: Maestro reads **only `.context.md` files** instead of raw code.
- `.context.md` files are the "compiled knowledge" of the codebase.
- Raw code is only read when the context file is stale or insufficient.

---

## 6. Bootstrap (First Use)

### 6.1 Trigger

When the framework is copied to a project for the first time, or when `.context.md` / `FEATURE-MAP.md` don't exist.

### 6.2 Flow

1. Maestro detects: no knowledge files exist (or they're empty/outdated).
2. Maestro delegates to **Contextualizer**.
3. Contextualizer performs **full scan** of `src/` (or equivalent):
   - Reads directory structure.
   - Reads key files (entry points, configs, READMEs).
   - Generates `.context.md` for each meaningful directory.
   - Generates `docs/FEATURE-MAP.md` with end-to-end feature flows.
4. Contextualizer presents results to user for **confirmation before saving**.
5. User approves → files are written.

### 6.3 Subsequent Sessions

1. Maestro checks: knowledge files exist.
2. Runs **git-based diff** to detect changes since last `.context.md` update.
3. If changes found: asks user if they want to update stale contexts.
4. If no changes: proceeds directly with the task.

---

## 7. Review Protocol

### 7.1 Output Format

The Reviewer produces **analysis + checklist**:

```markdown
## Review: [Feature/Change Name]

### Analysis
Brief narrative explaining the overall quality, notable patterns, and concerns.

### Checklist

**MUST FIX** (blocking):
- [ ] Description of issue → file:line → why it's blocking

**SHOULD FIX** (important, can be deferred):
- [ ] Description → file:line → impact

**NICE TO HAVE** (improvements):
- [ ] Description → suggestion

### Verdict: APPROVE | REQUEST CHANGES
```

### 7.2 Tester Protocol

- Tester runs **after** Coder, **before** Reviewer.
- Focuses on: edge cases, error scenarios, race conditions, security implications.
- Does NOT duplicate happy-path tests the Coder already wrote.
- Output: list of test cases written + coverage assessment.

### 7.3 Test Policy

- **Default: required** — every implementation must have tests.
- **Escape hatch**: `tests: skip` flag in CLAUDE.md or per-task override.
- Configurable per project via CLAUDE.md: `tests: required | suggested | skip`.

---

## 8. Configuration (CLAUDE.md)

The template generates a default `CLAUDE.md` with these configurable sections:

```markdown
# Project AI Setup

## Framework
- Location: .agents/
- Pattern: canuto | foreign-schema (auto-detected)

## Preferences
- tests: required | suggested | skip
- handoff-verbosity: explicit | silent | milestones-only
- session-briefing: true | false

## Providers
- primary: claude
- coder: codex | claude | glm
- tester: claude | codex
- debugger: claude
- reviewer: claude

## Squads
- mode: auto | manual | disabled
- max-parallel: 2

## Project Rules
- [Project-specific rules go here]

## On Session Start
1. Read .agents/memory/last-session.md
2. Check for stale contexts
3. Scan plugins
4. Brief the user
5. Ask what to work on
```

---

## 9. Priorities & Roadmap

### Phase 1 — Foundation ✅
1. **Improve persona compliance** — rewrite all personas with better prompts, examples, anti-patterns.
2. **Create Contextualizer persona** — the bootstrap engine.
3. **Create memory structure** — `last-session.md`, `decisions.md`, `pending.md`.
4. **Translate skills to English** — standardize language.

### Phase 2 — New Personas & Skills ✅
5. **Create Tester persona**.
6. **Create Debugger persona**.
7. **Create `security-practices` skill**.
8. **Create `git-workflow` skill**.

### Phase 3 — Template & Distribution ✅
9. **Create GitHub template repo** with `.agents/` + default `CLAUDE.md`.
10. **Document the template** with usage instructions.

### Phase 4 — Advanced ✅
11. **Plugin architecture** — `plugin-system` skill with `plugins/` folder convention, `plugin.md` manifest, and resolution rules.
12. **Multi-provider orchestration** — `multi-provider` skill with tier system, delegation protocol, fallback strategy, and provider config in CLAUDE.md.
13. **Metrics system** — `metrics` skill with quality/velocity/compliance tracking, `metrics.md` memory file, and trend analysis.
14. **Squads** — `squads` skill with domain-based grouping, parallel execution, cross-squad coordination, and configurable mode.

---

## 10. Skills Inventory (Complete)

### Core Skills
| Skill | Purpose |
|-------|--------|
| `context-maintenance` | How to maintain `.context.md` and `FEATURE-MAP.md` |
| `api-design` | How to design and evolve HTTP/JSON APIs |
| `frontend-implementation` | How to implement frontend features |
| `cli-usage` | How to safely use CLI commands and scripts |
| `security-practices` | Rules for secrets, env vars, and security hygiene |
| `git-workflow` | Branching, commits, and PR conventions (opt-in) |

### Advanced Skills
| Skill | Purpose |
|-------|--------|
| `plugin-system` | How to create, install, and manage opt-in plugins |
| `multi-provider` | How Maestro delegates work to Claude, Codex, GLM |
| `metrics` | How to track quality, velocity, and compliance |
| `squads` | How to group personas into parallel workstreams |

---

## 11. Open Questions (Remaining)

- Multi-provider API delegation: actual integration depends on API access and tool capabilities per environment.
- Squads in practice: needs real-world testing to validate the 30% overlap threshold and max-parallel defaults.
- Metrics automation: some metrics may be hard to collect automatically — needs iteration.

---

*Canuto Framework Spec v1.0 — Rodrigo Canuto © 2026*
